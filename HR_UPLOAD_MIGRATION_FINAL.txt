â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     HR UPLOAD FIX - FIXED DATABASE MIGRATION (with -h localhost)          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸš¨ PROBLEM: Peer Authentication Failed
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Error: Peer authentication failed for user "fyp_user"

ROOT CAUSE:
- Without -h flag: Uses Unix socket â†’ Peer authentication (system user = db user)
- With -h localhost: Uses TCP/IP â†’ Password authentication âœ…

You logged in as 'ubuntu' but trying to connect as 'fyp_user' â†’ Mismatch!


âœ… CORRECT COMMANDS (WITH -h localhost)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

METHOD 1: Run Migration SQL File (RECOMMENDED)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
cd /home/ubuntu/fyp_system/backend

PGPASSWORD='GL5jYNDqsOVkx6tIfIS2eUonM' psql -h localhost -U fyp_user -d fyp_db -f migrations/add_document_types_to_enum.sql
                                              ^^^^^^^^^^^^
                                              THIS IS CRITICAL!


METHOD 2: Interactive Session
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PGPASSWORD='GL5jYNDqsOVkx6tIfIS2eUonM' psql -h localhost -U fyp_user -d fyp_db
                                              ^^^^^^^^^^^^

Then paste:
ALTER TYPE employee_documents_document_type_enum ADD VALUE IF NOT EXISTS 'EMPLOYMENT_AGREEMENT';
ALTER TYPE employee_documents_document_type_enum ADD VALUE IF NOT EXISTS 'CERTIFICATION';
ALTER TYPE employee_documents_document_type_enum ADD VALUE IF NOT EXISTS 'PERFORMANCE_REVIEW';
\q


METHOD 3: One-Line Command
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PGPASSWORD='GL5jYNDqsOVkx6tIfIS2eUonM' psql -h localhost -U fyp_user -d fyp_db -c "ALTER TYPE employee_documents_document_type_enum ADD VALUE IF NOT EXISTS 'EMPLOYMENT_AGREEMENT'; ALTER TYPE employee_documents_document_type_enum ADD VALUE IF NOT EXISTS 'CERTIFICATION'; ALTER TYPE employee_documents_document_type_enum ADD VALUE IF NOT EXISTS 'PERFORMANCE_REVIEW';"


âœ… VERIFY MIGRATION
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
PGPASSWORD='GL5jYNDqsOVkx6tIfIS2eUonM' psql -h localhost -U fyp_user -d fyp_db -c "SELECT unnest(enum_range(NULL::employee_documents_document_type_enum));"
                                              ^^^^^^^^^^^^

Expected output:
              unnest              
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 RESUME
 EMPLOYMENT_CONTRACT
 OFFER_LETTER
 IDENTITY_DOCUMENT
 OTHER
 EMPLOYMENT_AGREEMENT    â† NEW
 CERTIFICATION           â† NEW
 PERFORMANCE_REVIEW      â† NEW
(8 rows)


ğŸ“‹ COMPLETE DEPLOYMENT SEQUENCE (COPY-PASTE READY)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# On EC2, run these commands in order:

cd /home/ubuntu/fyp_system
git pull origin main
cd backend

# Run migration with -h localhost
PGPASSWORD='GL5jYNDqsOVkx6tIfIS2eUonM' psql -h localhost -U fyp_user -d fyp_db -f migrations/add_document_types_to_enum.sql

# Verify (should show 8 values)
PGPASSWORD='GL5jYNDqsOVkx6tIfIS2eUonM' psql -h localhost -U fyp_user -d fyp_db -c "SELECT unnest(enum_range(NULL::employee_documents_document_type_enum));"

# Rebuild backend
npm run build

# Restart backend
cd ..
pm2 restart backend

# Watch logs
pm2 logs backend --lines 0


ğŸ” UNDERSTANDING THE ERROR
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Connection Method Comparison:

WITHOUT -h localhost (WRONG):
  psql -U fyp_user -d fyp_db
  â†“
  Uses: Unix socket (/var/run/postgresql/.s.PGSQL.5432)
  Auth: Peer authentication (system user must = db user)
  Result: âŒ ubuntu â‰  fyp_user â†’ FAIL

WITH -h localhost (CORRECT):
  psql -h localhost -U fyp_user -d fyp_db
  â†“
  Uses: TCP/IP (localhost:5432)
  Auth: Password authentication (uses PGPASSWORD)
  Result: âœ… Password matches â†’ SUCCESS


ğŸ“š TECHNICAL DETAILS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

PostgreSQL has two authentication modes in pg_hba.conf:

1. Peer Authentication (local/Unix socket):
   - Checks if system user = database user
   - No password needed
   - Only works if logged in as matching user
   - Example: ubuntu user â†’ can only connect as ubuntu db user

2. Password Authentication (TCP/IP):
   - Checks password from PGPASSWORD or prompt
   - System user doesn't matter
   - Works from any system user
   - Example: ubuntu user â†’ can connect as any db user with password


ğŸ¯ WHY YOUR BACKEND WORKS BUT MANUAL CONNECTION FAILS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Your backend .env has:
  DB_HOST=localhost    â† Uses TCP/IP, password auth âœ…

Your manual command was:
  psql -U fyp_user -d fyp_db    â† No -h, uses Unix socket, peer auth âŒ

Fix:
  psql -h localhost -U fyp_user -d fyp_db    â† Now uses TCP/IP âœ…


âŒ WRONG (Will Fail):
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
psql -U fyp_user -d fyp_db
PGPASSWORD='...' psql -U fyp_user -d fyp_db


âœ… CORRECT (Will Work):
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
psql -h localhost -U fyp_user -d fyp_db
PGPASSWORD='...' psql -h localhost -U fyp_user -d fyp_db


ğŸ’¡ ALTERNATIVE: Switch to postgres User (If -h localhost Doesn't Work)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

If -h localhost fails for some reason, you can:

sudo -i -u postgres
psql -d fyp_db -c "ALTER TYPE employee_documents_document_type_enum ADD VALUE IF NOT EXISTS 'EMPLOYMENT_AGREEMENT';"
psql -d fyp_db -c "ALTER TYPE employee_documents_document_type_enum ADD VALUE IF NOT EXISTS 'CERTIFICATION';"
psql -d fyp_db -c "ALTER TYPE employee_documents_document_type_enum ADD VALUE IF NOT EXISTS 'PERFORMANCE_REVIEW';"
exit


ğŸ¯ SUCCESS INDICATORS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… No "Peer authentication failed" error
âœ… Migration runs without errors
âœ… Verification shows 8 enum values (not 5)
âœ… Backend builds and restarts successfully
âœ… Upload with "Certification" works
âœ… Backend logs show "Document saved successfully"


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  KEY TAKEAWAY: ALWAYS use -h localhost when connecting as fyp_user!       â•‘
â•‘  This ensures password authentication instead of peer authentication.      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
