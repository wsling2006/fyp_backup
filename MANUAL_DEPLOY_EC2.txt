â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                â•‘
â•‘     ğŸš¨ MANUAL DEPLOYMENT (If Script Fails) ğŸš¨                 â•‘
â•‘                                                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

If the automated deployment script fails, follow these MANUAL steps:

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“‹ STEP-BY-STEP MANUAL DEPLOYMENT ON EC2:

1ï¸âƒ£  PULL LATEST CODE
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   cd ~/fyp_system
   git pull

   Expected output:
   âœ“ Should pull commits 5d648ca, 546893d, 3e263bb


2ï¸âƒ£  GO TO BACKEND DIRECTORY
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   cd backend


3ï¸âƒ£  CHECK TYPESCRIPT (Optional but recommended)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   npx tsc --noEmit

   If there are errors, that's okay - try building anyway.
   The important errors should be fixed now.


4ï¸âƒ£  BUILD THE BACKEND (CRITICAL STEP!)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   npm run build

   This compiles TypeScript â†’ JavaScript
   
   â±ï¸  Takes 30-60 seconds
   
   Expected output:
   âœ“ Compiling...
   âœ“ Successfully compiled
   âœ“ Creates/updates backend/dist directory


5ï¸âƒ£  VERIFY BUILD WAS SUCCESSFUL
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ls -lh dist/
   
   Should see directories like:
   - employees/
   - audit/
   - users/
   etc.

   Now check for the specific file:
   find dist -name "hr.controller.js"
   
   Should find: dist/employees/hr.controller.js (or similar)


6ï¸âƒ£  VERIFY ANTI-SPAM CODE IS COMPILED
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   # Find the compiled controller
   COMPILED=$(find dist -name "hr.controller.js")
   
   # Check for anti-spam logic
   grep -q "viewedEmployees" $COMPILED && echo "âœ“ Anti-spam code found!" || echo "âœ— Not found"
   
   # Check for debug logs
   grep -q "AUDIT SPAM DEBUG" $COMPILED && echo "âœ“ Debug logs found!" || echo "âš  Not found"


7ï¸âƒ£  RESTART PM2 BACKEND
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   cd ~/fyp_system
   pm2 restart backend

   Expected output:
   âœ“ backend restarted


8ï¸âƒ£  CHECK BACKEND IS RUNNING
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   pm2 list

   Should show:
   backend | online | 0 restarts (or low number)


9ï¸âƒ£  VIEW RECENT LOGS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   pm2 logs backend --lines 30

   Should see:
   - "Nest application successfully started"
   - No immediate errors

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ§ª NOW TEST IT:

1. Clear browser cache (Ctrl+Shift+Delete)
2. Clear localStorage (F12 â†’ Application â†’ Local Storage â†’ Clear)
3. Login as HR user
4. View an employee profile

5. CHECK LOGS (Terminal 1):
   pm2 logs backend

6. In browser: Refresh the page (F5)

7. CHECK LOGS AGAIN:
   You should see debug messages like:
   [AUDIT SPAM DEBUG] userId=abc123, employeeId=456, hasViewedBefore=false
   [AUDIT SPAM DEBUG] First view - creating audit log
   
   Then on refresh:
   [AUDIT SPAM DEBUG] userId=abc123, employeeId=456, hasViewedBefore=true
   [AUDIT SPAM DEBUG] Already viewed, skipping audit log

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ› COMMON ISSUES:

ISSUE: "npm run build" fails
   SOLUTION:
   - Check Node.js version: node --version (should be 18+)
   - Try: rm -rf node_modules && npm install
   - Then: npm run build

ISSUE: dist directory is empty after build
   SOLUTION:
   - Check for TypeScript errors: npx tsc --noEmit
   - Check tsconfig.json exists in backend/
   - Try: npm run build:prod (if that script exists)

ISSUE: PM2 restart fails
   SOLUTION:
   - Check PM2 is installed: pm2 --version
   - Try: pm2 delete backend && pm2 start ecosystem.config.js
   - Or: cd backend && pm2 start dist/main.js --name backend

ISSUE: Backend crashes immediately after restart
   SOLUTION:
   - Check logs: pm2 logs backend --err
   - Look for database connection errors
   - Check .env file exists and has correct DATABASE_URL

ISSUE: No debug logs appear even after deploy
   SOLUTION:
   - Verify compiled code has debug logs:
     grep "AUDIT SPAM DEBUG" dist/employees/hr.controller.js
   - Make sure you're logged in as HR role
   - Try viewing a different employee
   - Check logs in real-time: pm2 logs backend (leave running)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… SUCCESS CHECKLIST:

â–¡ Git pull successful
â–¡ npm run build completed without fatal errors
â–¡ dist/employees/hr.controller.js exists
â–¡ Anti-spam code (viewedEmployees) is in compiled file
â–¡ PM2 backend shows "online"
â–¡ No errors in pm2 logs backend
â–¡ Debug logs appear when viewing employee profile
â–¡ "Already viewed" message appears on page refresh
â–¡ NO duplicate "Employee View" audit logs

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ’¡ QUICK VERIFICATION:

All in one command block (copy-paste this):

cd ~/fyp_system
git pull
cd backend
npm run build
pm2 restart backend
sleep 3
pm2 logs backend --lines 20

Then test in browser and watch logs!

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

If you still have issues after this, please share:
1. Output of: npm run build
2. Output of: find dist -name "*.controller.js"
3. Output of: pm2 logs backend --lines 50
