(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{4560:function(e,t,o){Promise.resolve().then(o.bind(o,7340))},7340:function(e,t,o){"use strict";o.r(t),o.d(t,{default:function(){return n}});var r=o(2265),a=o(9376),s=o(575);function n(){let{token:e}=(0,s.a)(),t=(0,a.useRouter)();return(0,r.useEffect)(()=>{t.replace("/login")},[t]),null}},575:function(e,t,o){"use strict";o.d(t,{AuthProvider:function(){return u},a:function(){return i}});var r=o(7437),a=o(2265),s=o(9116),n=o(9376);let l=(0,a.createContext)(void 0),u=e=>{let{children:t}=e,[o,u]=(0,a.useState)(null),[i,d]=(0,a.useState)(null),[c,v]=(0,a.useState)(!1),[p,g]=(0,a.useState)(null),f=(0,n.useRouter)();(0,a.useEffect)(()=>{let e=localStorage.getItem("token"),t=localStorage.getItem("user");e&&u(e),t&&d(JSON.parse(t))},[]);let h=async(e,t)=>{v(!0),g(null);let o=e.trim();try{let e=await s.Z.post("/auth/login",{email:o,password:t});if(e.data.requiresOtp)return{requiresOtp:!0};if(e.data.access_token&&e.data.user)return u(e.data.access_token),d(e.data.user),localStorage.setItem("token",e.data.access_token),localStorage.setItem("user",JSON.stringify(e.data.user)),{access_token:e.data.access_token,user:e.data.user};return g("Invalid response from server."),{}}catch(e){var r,a,n,l,i,c,p,f,h,m,k,_;if(console.log("[Auth] Login error status:",null===(r=e.response)||void 0===r?void 0:r.status),console.log("[Auth] Login error data:",null===(a=e.response)||void 0===a?void 0:a.data),(null===(l=e.response)||void 0===l?void 0:null===(n=l.data)||void 0===n?void 0:n.locked)===!0&&(null===(c=e.response)||void 0===c?void 0:null===(i=c.data)||void 0===i?void 0:i.email))return console.log("[Auth] OTP required (account locked)"),{requiresOtp:!0,email:e.response.data.email};if((null===(f=e.response)||void 0===f?void 0:null===(p=f.data)||void 0===p?void 0:p.suspended)===!0)return g((null===(_=e.response)||void 0===_?void 0:null===(k=_.data)||void 0===k?void 0:k.message)||"Your account has been suspended. Please contact an administrator."),{};return g((null===(m=e.response)||void 0===m?void 0:null===(h=m.data)||void 0===h?void 0:h.message)||"Login failed"),{}}finally{v(!1)}},m=async e=>{v(!0),g(null),console.log("[Auth] Requesting OTP for forgot password:",e);try{let t=await s.Z.post("/auth/forgot-password",{email:e});return console.log("[Auth] Forgot password response:",t.data),!0}catch(e){var t,o;return g((null===(o=e.response)||void 0===o?void 0:null===(t=o.data)||void 0===t?void 0:t.message)||"Failed to request password reset OTP"),console.error("[Auth] Forgot password error:",e),!1}finally{v(!1)}},k=async(e,t)=>{v(!0),g(null),console.log("[Auth] Attempting OTP verification for email:",e);try{let o=await s.Z.post("/auth/verify-otp",{email:e,otp:t});if(console.log("[Auth] Response from /auth/verify-otp:",o.data),o.data.otp_reset)return console.log("[Auth] OTP verified, got otp_reset:",o.data.otp_reset),{otp_reset:o.data.otp_reset,type:"reset"};if(o.data.access_token&&o.data.user)return u(o.data.access_token),d(o.data.user),localStorage.setItem("token",o.data.access_token),localStorage.setItem("user",JSON.stringify(o.data.user)),{access_token:o.data.access_token,user:o.data.user,type:"mfa"};return g("Invalid OTP or response."),!1}catch(e){var o,r;return g((null===(r=e.response)||void 0===r?void 0:null===(o=r.data)||void 0===o?void 0:o.message)||"OTP verification failed"),!1}finally{v(!1)}},_=async(e,t,o,r)=>{v(!0),g(null);try{let a=await s.Z.post("/auth/reset-password",{email:e,otp_reset:t,newPassword:o,confirmPassword:r});return console.log("[Auth] Password reset response:",a.data),!0}catch(e){var a,n;return g((null===(n=e.response)||void 0===n?void 0:null===(a=n.data)||void 0===a?void 0:a.message)||"Password reset failed"),console.error("[Auth] Password reset error:",e),!1}finally{v(!1)}};return(0,r.jsx)(l.Provider,{value:{token:o,user:i,loading:c,error:p,login:h,forgotPassword:m,verifyOtp:k,logout:()=>{console.log("[Auth] Logging out user"),u(null),d(null),localStorage.removeItem("token"),localStorage.removeItem("user"),f.push("/login")},resetPassword:_},children:t})},i=()=>{let e=(0,a.useContext)(l);if(!e)throw Error("useAuth must be used within AuthProvider");return e}},9116:function(e,t,o){"use strict";let r=o(3464).Z.create({baseURL:"http://47.128.68.111:3000",withCredentials:!0,headers:{"Content-Type":"application/json"}});r.interceptors.request.use(e=>{try{let t=localStorage.getItem("token");t&&e.headers&&(e.headers.Authorization="Bearer ".concat(t))}catch(e){console.warn("[API] Failed to read token from localStorage:",e)}return e}),r.interceptors.response.use(e=>e,e=>Promise.reject(e)),t.Z=r}},function(e){e.O(0,[301,971,117,744],function(){return e(e.s=4560)}),_N_E=e.O()}]);