(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[836],{424:function(e,t,a){Promise.resolve().then(a.bind(a,8219))},8219:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return u},dynamic:function(){return c}});var s=a(7437),o=a(2265),r=a(575),n=a(9116),l=a(4226),i=a(1154),d=a(9376);let c="force-dynamic";function u(){let{user:e,token:t,logout:a}=(0,r.a)(),c=(0,d.useRouter)(),[u,p]=(0,o.useState)([]),[v,h]=(0,o.useState)(null),[m,f]=(0,o.useState)(!1),[g,x]=(0,o.useState)(null),y=(null==e?void 0:e.role)==="accountant"||(null==e?void 0:e.role)==="super_admin";(0,o.useEffect)(()=>{y&&(async()=>{try{let e=await n.Z.get("/accountant-files");p(e.data.files||[])}catch(r){var e,t,s,o;(null===(e=r.response)||void 0===e?void 0:e.status)===401||(null===(t=r.response)||void 0===t?void 0:t.status)===403?(x("Unauthorized. Logging out."),a()):x((null===(o=r.response)||void 0===o?void 0:null===(s=o.data)||void 0===s?void 0:s.message)||"Failed to load files")}})()},[y,a]);let w=async e=>{if(e.type&&"application/octet-stream"!==e.type)return e.type.startsWith("text/")||"application/xml"===e.type||"application/json"===e.type;if(e.name&&e.name.toLowerCase().endsWith(".txt"))return!0;let t=e.slice(0,Math.min(4096,e.size)),a=new Uint8Array(await t.arrayBuffer()),s=0;for(let e=0;e<a.length;e++){let t=a[e];if(9!==t&&10!==t&&13!==t&&(!(t>=32)||!(t<=126))&&++s>.1*a.length)return!1}return!0},b=async()=>{if(!v){x("Please choose a file first");return}if(x(null),v.size>10485760){x("File too large");return}let e=v.type&&(["application/pdf","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","text/plain"].includes(v.type)||v.type.startsWith("text/"))||""===v.type&&v.name.toLowerCase().endsWith(".txt")||"application/octet-stream"===v.type&&v.name.toLowerCase().endsWith(".txt"),t=!1;try{t=await w(v)}catch(e){t=!1,console.error("[Upload] text heuristic failed",e)}if(!(e||t)){x("Unsupported file type");return}f(!0);let s=new FormData;s.append("file",v);try{await n.Z.post("/accountant-files/upload",s,{headers:{"Content-Type":"multipart/form-data"},timeout:12e4}),x("Upload successful"),h(null);let e=await n.Z.get("/accountant-files");p(e.data.files||[])}catch(e){var o,r,l,i;x((null===(r=e.response)||void 0===r?void 0:null===(o=r.data)||void 0===o?void 0:o.message)||"Upload failed"),((null===(l=e.response)||void 0===l?void 0:l.status)===401||(null===(i=e.response)||void 0===i?void 0:i.status)===403)&&a()}finally{f(!1);let e=document.querySelector("input[type=file]");e&&(e.value="")}},j=async(e,t)=>{try{let a=await n.Z.get("/accountant-files/".concat(e),{responseType:"blob"}),s=window.URL.createObjectURL(new Blob([a.data])),o=document.createElement("a");o.href=s,o.download=t,o.click(),window.URL.revokeObjectURL(s)}catch(e){var s,o,r,l;x((null===(o=e.response)||void 0===o?void 0:null===(s=o.data)||void 0===s?void 0:s.message)||"Download failed"),((null===(r=e.response)||void 0===r?void 0:r.status)===401||(null===(l=e.response)||void 0===l?void 0:l.status)===403)&&a()}},N=async(e,t)=>{if(confirm('Are you sure you want to delete "'.concat(t,'"?')))try{await n.Z.delete("/accountant-files/".concat(e)),x("File deleted successfully");let t=await n.Z.get("/accountant-files");p(t.data.files||[])}catch(e){var s,o,r,l;x((null===(o=e.response)||void 0===o?void 0:null===(s=o.data)||void 0===s?void 0:s.message)||"Delete failed"),((null===(r=e.response)||void 0===r?void 0:r.status)===401||(null===(l=e.response)||void 0===l?void 0:l.status)===403)&&a()}};return y?(0,s.jsxs)("div",{className:"p-6 space-y-6",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center gap-4",children:[(null==e?void 0:e.role)==="super_admin"&&(0,s.jsx)(l.Z,{onClick:()=>c.push("/dashboard/superadmin"),className:"bg-gray-200 text-black hover:bg-gray-300 w-auto px-3 py-1",children:"Back"}),(0,s.jsx)("h1",{className:"text-2xl font-bold",children:"Accountant Dashboard"})]}),(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsxs)("label",{className:"cursor-pointer bg-white border rounded px-3 py-2",children:[(0,s.jsx)("input",{type:"file",className:"hidden",onChange:e=>{var t;let a=(null===(t=e.target.files)||void 0===t?void 0:t[0])||null;x(null),h(a)}}),(0,s.jsx)("span",{className:"text-sm",children:"Choose File"})]}),(0,s.jsx)(l.Z,{onClick:b,disabled:m||!v,children:m?(0,s.jsxs)("span",{className:"flex items-center gap-2",children:[(0,s.jsx)(i.Z,{}),"Scanning file..."]}):"Upload"})]})]}),v&&(0,s.jsxs)("div",{className:"text-sm text-gray-700",children:["Selected: ",v.name," (",(v.size/1024).toFixed(1)," KB)"]}),g&&(0,s.jsx)("div",{className:"text-sm text-gray-700",children:g}),(0,s.jsxs)("div",{className:"border rounded",children:[(0,s.jsxs)("div",{className:"grid grid-cols-5 gap-4 p-3 font-semibold bg-gray-50",children:[(0,s.jsx)("div",{children:"Filename"}),(0,s.jsx)("div",{children:"Type"}),(0,s.jsx)("div",{children:"Size"}),(0,s.jsx)("div",{children:"Uploaded By"}),(0,s.jsx)("div",{children:"Action"})]}),u.map(e=>{var t;return(0,s.jsxs)("div",{className:"grid grid-cols-5 gap-4 p-3 border-t",children:[(0,s.jsx)("div",{children:e.filename}),(0,s.jsx)("div",{className:"text-xs text-gray-600",children:e.mimetype}),(0,s.jsxs)("div",{className:"text-xs",children:[(e.size/1024).toFixed(1)," KB"]}),(0,s.jsx)("div",{className:"text-xs",children:(null===(t=e.uploaded_by)||void 0===t?void 0:t.email)||"Unknown"}),(0,s.jsx)("div",{children:(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(l.Z,{onClick:()=>j(e.id,e.filename),disabled:m,children:"Download"}),(0,s.jsx)(l.Z,{onClick:()=>N(e.id,e.filename),disabled:m,className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})})]},e.id)}),0===u.length&&(0,s.jsx)("div",{className:"p-4 text-sm text-gray-500",children:"No files uploaded yet."})]})]}):(0,s.jsxs)("div",{className:"p-6",children:[(0,s.jsx)("h1",{className:"text-xl font-semibold",children:"Unauthorized"}),(0,s.jsx)("p",{className:"text-gray-600",children:"You do not have access to the Accountant dashboard."})]})}},4226:function(e,t,a){"use strict";var s=a(7437);a(2265),t.Z=e=>{let{className:t="",variant:a="primary",children:o,...r}=e;return(0,s.jsx)("button",{className:"\n        ".concat({primary:"bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white shadow-lg shadow-blue-500/50 hover:shadow-blue-600/50",secondary:"bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white shadow-lg shadow-gray-500/50",danger:"bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-700 hover:to-pink-700 text-white shadow-lg shadow-red-500/50",success:"bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white shadow-lg shadow-green-500/50",outline:"bg-transparent border-2 border-blue-600 text-blue-600 hover:bg-blue-50 shadow-none"}[a],"\n        rounded-xl px-6 py-3 w-full font-semibold\n        transition-all duration-300 \n        transform hover:scale-[1.02] active:scale-[0.98]\n        disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none\n        focus:outline-none focus:ring-4 focus:ring-blue-500/50\n        ").concat(t,"\n      "),...r,children:o})}},1154:function(e,t,a){"use strict";var s=a(7437);a(2265),t.Z=function(){return(0,s.jsx)("div",{className:"flex justify-center items-center",children:(0,s.jsx)("div",{className:"animate-spin rounded-full h-6 w-6 border-t-2 border-b-2 border-blue-500"})})}},575:function(e,t,a){"use strict";a.d(t,{AuthProvider:function(){return i},a:function(){return d}});var s=a(7437),o=a(2265),r=a(9116),n=a(9376);let l=(0,o.createContext)(void 0),i=e=>{let{children:t}=e,[a,i]=(0,o.useState)(null),[d,c]=(0,o.useState)(null),[u,p]=(0,o.useState)(!1),[v,h]=(0,o.useState)(null),m=(0,n.useRouter)();(0,o.useEffect)(()=>{let e=localStorage.getItem("token"),t=localStorage.getItem("user");e&&i(e),t&&c(JSON.parse(t))},[]);let f=async(e,t)=>{p(!0),h(null);let a=e.trim();try{let e=await r.Z.post("/auth/login",{email:a,password:t});if(e.data.requiresOtp)return{requiresOtp:!0};if(e.data.access_token&&e.data.user)return i(e.data.access_token),c(e.data.user),localStorage.setItem("token",e.data.access_token),localStorage.setItem("user",JSON.stringify(e.data.user)),{access_token:e.data.access_token,user:e.data.user};return h("Invalid response from server."),{}}catch(e){var s,o,n,l,d,u,v,m,f,g,x,y;if(console.log("[Auth] Login error status:",null===(s=e.response)||void 0===s?void 0:s.status),console.log("[Auth] Login error data:",null===(o=e.response)||void 0===o?void 0:o.data),(null===(l=e.response)||void 0===l?void 0:null===(n=l.data)||void 0===n?void 0:n.locked)===!0&&(null===(u=e.response)||void 0===u?void 0:null===(d=u.data)||void 0===d?void 0:d.email))return console.log("[Auth] OTP required (account locked)"),{requiresOtp:!0,email:e.response.data.email};if((null===(m=e.response)||void 0===m?void 0:null===(v=m.data)||void 0===v?void 0:v.suspended)===!0)return h((null===(y=e.response)||void 0===y?void 0:null===(x=y.data)||void 0===x?void 0:x.message)||"Your account has been suspended. Please contact an administrator."),{};return h((null===(g=e.response)||void 0===g?void 0:null===(f=g.data)||void 0===f?void 0:f.message)||"Login failed"),{}}finally{p(!1)}},g=async e=>{p(!0),h(null),console.log("[Auth] Requesting OTP for forgot password:",e);try{let t=await r.Z.post("/auth/forgot-password",{email:e});return console.log("[Auth] Forgot password response:",t.data),!0}catch(e){var t,a;return h((null===(a=e.response)||void 0===a?void 0:null===(t=a.data)||void 0===t?void 0:t.message)||"Failed to request password reset OTP"),console.error("[Auth] Forgot password error:",e),!1}finally{p(!1)}},x=async(e,t)=>{p(!0),h(null),console.log("[Auth] Attempting OTP verification for email:",e);try{let a=await r.Z.post("/auth/verify-otp",{email:e,otp:t});if(console.log("[Auth] Response from /auth/verify-otp:",a.data),a.data.otp_reset)return console.log("[Auth] OTP verified, got otp_reset:",a.data.otp_reset),{otp_reset:a.data.otp_reset,type:"reset"};if(a.data.access_token&&a.data.user)return i(a.data.access_token),c(a.data.user),localStorage.setItem("token",a.data.access_token),localStorage.setItem("user",JSON.stringify(a.data.user)),{access_token:a.data.access_token,user:a.data.user,type:"mfa"};return h("Invalid OTP or response."),!1}catch(e){var a,s;return h((null===(s=e.response)||void 0===s?void 0:null===(a=s.data)||void 0===a?void 0:a.message)||"OTP verification failed"),!1}finally{p(!1)}},y=async(e,t,a,s)=>{p(!0),h(null);try{let o=await r.Z.post("/auth/reset-password",{email:e,otp_reset:t,newPassword:a,confirmPassword:s});return console.log("[Auth] Password reset response:",o.data),!0}catch(e){var o,n;return h((null===(n=e.response)||void 0===n?void 0:null===(o=n.data)||void 0===o?void 0:o.message)||"Password reset failed"),console.error("[Auth] Password reset error:",e),!1}finally{p(!1)}};return(0,s.jsx)(l.Provider,{value:{token:a,user:d,loading:u,error:v,login:f,forgotPassword:g,verifyOtp:x,logout:()=>{console.log("[Auth] Logging out user"),i(null),c(null),localStorage.removeItem("token"),localStorage.removeItem("user"),m.push("/login")},resetPassword:y},children:t})},d=()=>{let e=(0,o.useContext)(l);if(!e)throw Error("useAuth must be used within AuthProvider");return e}},9116:function(e,t,a){"use strict";let s=a(3464).Z.create({baseURL:"http://47.128.68.111:3000",withCredentials:!0,headers:{"Content-Type":"application/json"}});s.interceptors.request.use(e=>{try{let t=localStorage.getItem("token");t&&e.headers&&(e.headers.Authorization="Bearer ".concat(t))}catch(e){console.warn("[API] Failed to read token from localStorage:",e)}return e}),s.interceptors.response.use(e=>e,e=>Promise.reject(e)),t.Z=s}},function(e){e.O(0,[301,971,117,744],function(){return e(e.s=424)}),_N_E=e.O()}]);