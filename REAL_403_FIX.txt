â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   ğŸš¨ REAL 403 ERROR SOLUTION ğŸš¨                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

You're getting 403 AFTER successful login. This means:
âœ… Login works (you get past OTP)
âœ… Token is created
âŒ Token is REJECTED when accessing /api/purchase-requests

ROOT CAUSE (One of these):
1. JWT_SECRET changed after you logged in
2. User role in database doesn't match expectations
3. Token not being sent in Authorization header
4. Backend not reading Authorization header from proxy

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ SOLUTION 1: FORCE FRESH LOGIN (Try this FIRST)

This forces a new token with correct JWT_SECRET:

IN BROWSER:
  1. Press F12 (open console)
  2. Paste this:
     localStorage.clear();
     location.reload();

  3. Login again with your sales_department credentials
  4. Complete OTP if prompted
  5. Try accessing purchase requests

WHY: Old token might be using wrong JWT_SECRET

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ SOLUTION 2: CHECK WHAT'S REALLY HAPPENING

ON EC2, run this command:
  cd /home/ubuntu/fyp_system
  ./debug-backend-auth.sh

This will show:
  - JWT_SECRET configuration
  - Database user roles
  - Backend authentication logs
  - Direct API test

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ SOLUTION 3: VERIFY AUTHORIZATION HEADER

IN BROWSER (F12 Console), paste this:

```javascript
// Test if token is being sent
fetch('/api/purchase-requests', {
  method: 'GET',
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('token')}`,
    'Content-Type': 'application/json'
  }
})
.then(r => r.text())
.then(text => {
  console.log('Response:', text);
  if (text.includes('403') || text.includes('Forbidden')) {
    console.error('âŒ Backend is REJECTING the token');
    console.log('Token being sent:', localStorage.getItem('token').substring(0, 50) + '...');
  }
});
```

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ SOLUTION 4: CHECK DATABASE ROLE

ON EC2:
  sudo -u postgres psql -d fyp_db -c \
    "SELECT email, role, is_active, suspended FROM users WHERE email='YOUR_EMAIL';"

EXPECTED:
  role = 'sales_department' (EXACT match, lowercase)
  is_active = true
  suspended = false

IF WRONG:
  sudo -u postgres psql -d fyp_db -c \
    "UPDATE users SET role='sales_department', is_active=true, suspended=false WHERE email='YOUR_EMAIL';"

  Then logout and re-login!

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ SOLUTION 5: RESTART BACKEND WITH CORRECT JWT_SECRET

ON EC2:
  cd /home/ubuntu/fyp_system/backend
  
  # Check JWT_SECRET
  cat .env | grep JWT_SECRET
  
  # If missing or wrong, set it
  nano .env
  # Add or fix: JWT_SECRET=your_secure_secret_key_here
  
  # Restart backend
  pm2 restart backend
  
  # IMPORTANT: All users must logout and re-login after this!

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ SOLUTION 6: NUCLEAR OPTION (If nothing else works)

This completely resets authentication:

ON EC2:
  cd /home/ubuntu/fyp_system
  
  # Stop services
  pm2 stop all
  pm2 delete all
  
  # Ensure .env has JWT_SECRET
  echo "JWT_SECRET=$(openssl rand -base64 32)" >> backend/.env
  
  # Rebuild everything
  cd backend && npm run build
  cd ../frontend && npm run build
  
  # Start fresh
  cd ..
  pm2 start ecosystem.config.js
  pm2 save

IN BROWSER:
  # Clear everything
  localStorage.clear();
  sessionStorage.clear();
  
  # Ctrl+Shift+Delete â†’ Clear all cache
  
  # Login fresh

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ DIAGNOSTIC CHECKLIST

Run these and report results:

â–¡ 1. Browser Console Check
     localStorage.getItem('token')  // Should show long string
     localStorage.getItem('user')   // Should show user object

â–¡ 2. Backend Logs
     pm2 logs backend --lines 50 | grep -i "403\|forbidden\|jwt"

â–¡ 3. Database Role
     SELECT email, role FROM users WHERE email='YOUR_EMAIL';

â–¡ 4. JWT Secret
     cat /home/ubuntu/fyp_system/backend/.env | grep JWT_SECRET

â–¡ 5. Direct API Test
     ./debug-backend-auth.sh

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸš¨ MOST COMMON CAUSES (In order of likelihood)

1. âŒ Token created with old JWT_SECRET
   FIX: logout â†’ clear cache â†’ login

2. âŒ User role in DB is wrong ('sales' instead of 'sales_department')
   FIX: Update database â†’ logout â†’ login

3. âŒ Token expired
   FIX: logout â†’ login

4. âŒ Authorization header not being sent
   FIX: Check api.ts interceptor â†’ rebuild frontend

5. âŒ Backend JWT_SECRET missing or wrong in .env
   FIX: Set JWT_SECRET â†’ restart backend â†’ re-login

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ’¡ IMPORTANT NOTES

1. AFTER any backend .env changes: pm2 restart backend
2. AFTER any backend changes: ALL users must logout and re-login
3. JWT tokens are tied to the JWT_SECRET at creation time
4. Changing JWT_SECRET invalidates ALL existing tokens
5. User role in token MUST match Role enum exactly

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ WHAT TO SHARE IF STILL FAILING

1. Output of: ./debug-backend-auth.sh
2. Browser console output after running Solution 3 test
3. Output of: pm2 logs backend --lines 100 | grep -i "403\|jwt"
4. Database user: SELECT * FROM users WHERE email='YOUR_EMAIL';
5. Screenshot of Network tab showing the failed request headers

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âš¡ QUICK START (Do this NOW)

1. In browser: localStorage.clear(); location.reload();
2. Login again
3. Try purchase requests
4. If still 403: Run ./debug-backend-auth.sh on EC2 and share output

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
