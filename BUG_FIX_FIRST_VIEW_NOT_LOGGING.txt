â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                â•‘
â•‘         ğŸ› BUG FIX: First View Not Logging Issue ğŸ›           â•‘
â•‘                                                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ› THE BUG:

User reported strange behavior:
  âœ— Click "View Profile" button â†’ NO audit log
  âœ“ Refresh inside profile page â†’ Correctly no log
  âœ“ Edit and save â†’ Shows both UPDATE and VIEW logs

Expected:
  âœ“ First view should create audit log!

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ” ROOT CAUSE:

The frontend was checking sessionStorage BEFORE making the request:

```typescript
// BROKEN CODE:
const hasViewedBefore = sessionStorage.getItem(sessionKey) === 'true';
const useSilentMode = refreshParam === 'silent' || hasViewedBefore;
loadEmployeeDetails(useSilentMode);
```

Problems:
1. âŒ sessionStorage persists across tab closes/reopens
2. âŒ If key exists from previous session â†’ thinks already viewed
3. âŒ Sends ?silent=true on FIRST view
4. âŒ Backend skips audit log because of silent=true

This is why:
- First click â†’ sessionStorage found old data â†’ sent silent=true â†’ NO LOG âŒ
- Refresh â†’ Backend Map found it â†’ NO LOG âœ“ (correct)
- Edit/save â†’ Triggers redirect with ?refresh=silent â†’ Creates log on re-load âœ“

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… THE FIX:

Remove sessionStorage checks from frontend!
Let the BACKEND be the source of truth.

```typescript
// FIXED CODE:
const refreshParam = searchParams?.get('refresh');
const useSilentMode = refreshParam === 'silent';
// Only use silent mode if explicitly set in URL (after edit)
loadEmployeeDetails(useSilentMode);
```

Benefits:
1. âœ… Backend in-memory Map is authoritative
2. âœ… First view always goes to backend without silent flag
3. âœ… Backend decides whether to log or not
4. âœ… Frontend only sets silent=true after explicit actions (edit/update)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Š HOW IT WORKS NOW:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCENARIO 1: First View (Fresh)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User clicks "View Profile" button
  â†“
Frontend: No special flags, GET /hr/employees/123
  â†“
Backend: Check in-memory Map â†’ NOT FOUND
  â†“
Backend: Create audit log âœ…
  â†“
Backend: Add to Map: user â†’ [emp123]
  â†“
Result: âœ… AUDIT LOG CREATED


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCENARIO 2: Page Refresh                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User presses F5 to refresh
  â†“
Frontend: No special flags, GET /hr/employees/123
  â†“
Backend: Check in-memory Map â†’ FOUND!
  â†“
Backend: Skip audit log â›”
  â†“
Result: â›” NO LOG (spam prevented by backend)


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCENARIO 3: After Edit/Save                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User edits employee, clicks "Save Changes"
  â†“
Backend: UPDATE_EMPLOYEE action âœ…
  â†“
Backend: Redirects to /hr/employees/123?refresh=silent
  â†“
Frontend: Sees ?refresh=silent â†’ sends ?silent=true
  â†“
Backend: Sees silent=true â†’ Skip audit log â›”
  â†“
Result: â›” NO VIEW LOG (already logged update, don't spam)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ¯ KEY PRINCIPLE:

**Backend is the Source of Truth**

Frontend should NOT:
  âŒ Track what's been viewed (sessionStorage)
  âŒ Decide when to audit log
  âŒ Make assumptions about backend state

Frontend should ONLY:
  âœ… Send requests to backend
  âœ… Pass explicit flags (?refresh=silent after edits)
  âœ… Trust backend to handle audit logic

Backend in-memory Map:
  âœ… Tracks all views across all requests
  âœ… Prevents spam reliably
  âœ… Single source of truth
  âœ… Simple and effective

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ§ª TESTING AFTER FIX:

1. Clear ALL browser data (Ctrl+Shift+Delete)
   - Clear cache
   - Clear cookies
   - Clear local/session storage

2. Close browser completely

3. Reopen browser, login as HR user

4. Click "View Profile" on an employee
   â†’ Check logs: pm2 logs backend | grep "AUDIT SPAM DEBUG"
   â†’ Should see: âœ… "Creating audit log - First view in session"

5. Refresh page (F5)
   â†’ Check logs again
   â†’ Should see: â›” "Already viewed in this session"

6. Edit employee, change name, click "Save"
   â†’ Check logs
   â†’ Should see: âœ… "UPDATE_EMPLOYEE" (edit action)
   â†’ Should see: â›” "Silent mode" (skips view log on redirect)

7. Check audit log database/dashboard
   â†’ Should see ONE view log
   â†’ Should see ONE update log
   â†’ NO duplicate view logs!

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ FILES CHANGED:

frontend/app/hr/employees/[id]/page.tsx
  âœ… Removed: sessionStorage check before loading
  âœ… Removed: sessionStorage.setItem after loading
  âœ… Simplified: Only check ?refresh URL parameter
  âœ… Result: Backend handles all spam prevention

backend/src/employees/hr.controller.ts
  âœ… Already correct: In-memory Map tracking
  âœ… Already correct: Checks silent parameter
  âœ… No changes needed!

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸš€ DEPLOYMENT:

BACKEND (Already deployed):
  cd ~/fyp_system && git pull
  cd backend && npm run build && pm2 restart backend

FRONTEND:
  cd ~/fyp_system && git pull
  cd frontend && npm run build && pm2 restart frontend

OR if using npm run dev:
  cd ~/fyp_system && git pull
  # Frontend will auto-reload in dev mode

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… COMMIT: 8f3d84d
   "Fix: Remove sessionStorage check that prevented first audit log"

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ‰ RESULT:

âœ… First view now correctly creates audit log
âœ… Refresh correctly skips log (backend Map)
âœ… Edit/save correctly shows update + silent view
âœ… Simple, clean, reliable audit trail!

The system now works as expected! ğŸ¯
